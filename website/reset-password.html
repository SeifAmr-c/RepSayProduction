<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RepSay - Reset Password</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #0A0A0A;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 420px;
      padding: 24px;
    }
    .logo {
      text-align: center;
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 2px;
      color: #C8FF00;
      margin-bottom: 32px;
    }
    .card {
      background: #1A1A1A;
      border-radius: 16px;
      padding: 32px 24px;
    }
    .card h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .card p {
      color: #888;
      font-size: 14px;
      margin-bottom: 24px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 13px;
      color: #aaa;
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      background: #0A0A0A;
      border: 1px solid #333;
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-group input:focus {
      border-color: #C8FF00;
    }
    .btn {
      width: 100%;
      padding: 14px;
      background: #C8FF00;
      color: #000;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      margin-top: 8px;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .error {
      color: #ff6b6b;
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }
    .state { display: none; }
    .state.active { display: block; }
    .state-icon {
      text-align: center;
      font-size: 48px;
      margin-bottom: 16px;
      margin-top: 8px;
    }
    .state-msg {
      text-align: center;
      font-size: 16px;
      color: #fff;
      margin-bottom: 8px;
    }
    .state-sub {
      text-align: center;
      font-size: 13px;
      color: #888;
      margin-bottom: 20px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top: 3px solid #C8FF00;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">REPSAY</div>
    <div class="card">

      <!-- Loading State -->
      <div class="state active" id="loadingState">
        <h2 style="text-align:center">Verifying...</h2>
        <div class="spinner"></div>
        <p style="text-align:center">Please wait while we verify your reset link.</p>
      </div>

      <!-- Form State -->
      <div class="state" id="formState">
        <h2>Reset Your Password</h2>
        <p>Enter your new password below.</p>
        <form id="resetForm">
          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="newPassword" placeholder="At least 6 characters" required minlength="6">
          </div>
          <div class="form-group">
            <label>Confirm Password</label>
            <input type="password" id="confirmPassword" placeholder="Re-enter password" required minlength="6">
          </div>
          <div class="error" id="errorMsg"></div>
          <button type="submit" class="btn" id="submitBtn">Update Password</button>
        </form>
      </div>

      <!-- Success State -->
      <div class="state" id="successState">
        <div class="state-icon">✅</div>
        <div class="state-msg">Password Updated!</div>
        <div class="state-sub">Your password has been changed successfully. You can now open the RepSay app and log in with your new password.</div>
      </div>

      <!-- Error State -->
      <div class="state" id="errorState">
        <div class="state-icon">⚠️</div>
        <div class="state-msg">Invalid or Expired Link</div>
        <div class="state-sub">This password reset link is invalid or has expired. Please request a new reset link from the app.</div>
      </div>

    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    var SUPABASE_URL = 'https://uvxuygmivrbxsuxnwjnb.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2eHV5Z21pdnJieHN1eG53am5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMTQyMjEsImV4cCI6MjA4NDY5MDIyMX0.771uHYP0Vrv4VJAKp0eWuCl3xOfNYRmlLXTp2Djgyz0';

    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showState(id) {
      document.querySelectorAll('.state').forEach(function(s) { s.classList.remove('active'); });
      document.getElementById(id).classList.add('active');
    }

    function getQueryParams() {
      var search = window.location.search.substring(1);
      var params = {};
      if (!search) return params;
      search.split('&').forEach(function(part) {
        var kv = part.split('=');
        if (kv.length === 2) {
          params[decodeURIComponent(kv[0])] = decodeURIComponent(kv[1]);
        }
      });
      return params;
    }

    function getHashParams() {
      var hash = window.location.hash.substring(1);
      var params = {};
      if (!hash) return params;
      hash.split('&').forEach(function(part) {
        var kv = part.split('=');
        if (kv.length === 2) {
          params[decodeURIComponent(kv[0])] = decodeURIComponent(kv[1]);
        }
      });
      return params;
    }

    function setupForm() {
      document.getElementById('resetForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var errorEl = document.getElementById('errorMsg');
        var btn = document.getElementById('submitBtn');
        var newPwd = document.getElementById('newPassword').value;
        var confirmPwd = document.getElementById('confirmPassword').value;

        errorEl.style.display = 'none';

        if (newPwd.length < 6) {
          errorEl.textContent = 'Password must be at least 6 characters.';
          errorEl.style.display = 'block';
          return;
        }
        if (newPwd !== confirmPwd) {
          errorEl.textContent = 'Passwords do not match.';
          errorEl.style.display = 'block';
          return;
        }

        btn.disabled = true;
        btn.textContent = 'Updating...';

        try {
          var result = await sb.auth.updateUser({ password: newPwd });
          if (result.error) throw result.error;
          showState('successState');
        } catch (err) {
          errorEl.textContent = err.message || 'Failed to update password.';
          errorEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Update Password';
        }
      });
    }

    async function init() {
      var queryParams = getQueryParams();
      var hashParams = getHashParams();

      try {
        // Method 1: token_hash in query params (from custom email template)
        if (queryParams['token_hash']) {
          var verifyResult = await sb.auth.verifyOtp({
            token_hash: queryParams['token_hash'],
            type: 'recovery'
          });
          if (verifyResult.error) {
            console.error('Verify error:', verifyResult.error);
            showState('errorState');
            return;
          }
          showState('formState');
          setupForm();
          return;
        }

        // Method 2: access_token in hash (implicit flow)
        if (hashParams['access_token'] && hashParams['type'] === 'recovery') {
          var sessionResult = await sb.auth.setSession({
            access_token: hashParams['access_token'],
            refresh_token: hashParams['refresh_token'] || ''
          });
          if (sessionResult.error) {
            showState('errorState');
            return;
          }
          showState('formState');
          setupForm();
          return;
        }

        // Method 3: Fallback — auto-detect via onAuthStateChange
        var handled = false;
        sb.auth.onAuthStateChange(function(event, session) {
          if (event === 'PASSWORD_RECOVERY' && !handled) {
            handled = true;
            showState('formState');
            setupForm();
          }
        });

        setTimeout(function() {
          if (!handled && document.getElementById('loadingState').classList.contains('active')) {
            showState('errorState');
          }
        }, 5000);

      } catch (err) {
        console.error('Init error:', err);
        showState('errorState');
      }
    }

    init();
  </script>
</body>
</html>
